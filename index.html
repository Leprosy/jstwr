<!-- JSTWR -->
<!DOCTYPE html>
<html>
    <head>
        <style></style>
        <title>jstwr</title>
        <script src="js/crafty.js"></script>
    </head>
    <body>
        <div id="game"></div>

        <script>
/**
 * Game logic 
 */

/* Some parameters */
var Game = {};
Game.size = 32;
Game.version = 0.001;

/**
 * This is level data. Must be loaded from a JSON file/service
 */
Game.wave_num = 0;
Game.wave_sub = 0;
Game.path = [[50, 0], [200, 200], [350, 200], [0, 400]]; //Loaded from JSON
Game.creeps = { //Loaded from JSON
    "oawc": {
        name: "Oaw",
        hp: 20,
        speed: 1,
        color: "#ff0000"
    },
    "tldo": {
        name: "Taldo",
        hp: 40,
        speed: 2,
        color: "#ffff00"
    },
    "stld": {
        name: "Super Taldo",
        hp: 80,
        speed: 3,
        color: "#0000ff"
    },
};
Game.waves = [ //Loaded from JSON
    [{name: "oawc", total: 6, delay: 1000},
     {name: "tldo", total: 5, delay: 800}],
    
    [{name: "oawc", total: 10, delay: 1000},
     {name: "tldo", total: 8, delay: 800},
     {name: "stld", total: 4, delay: 1200}]
];


/* Entry point */
window.onload = function() {
    Crafty.init(Game.size * 20, Game.size * 20, "game");
    Crafty.background("#002200");
    Crafty.scene("loading");
};




/*
 * Components
 */
Crafty.c("tCreep", {
    init: function() {
        //Setup
        this.addComponent("2D, Canvas, Color");
        this.origin("center");
        this.w = Game.size;
        this.h = Game.size;

        //Put in position
        this.x = Game.path[0][0];
        this.y = Game.path[0][1];
        this.nextPoint = 1;
    },

    creep: function(data) {
        this.name = data.name;
        this.speed = data.speed;
        this.color(data.color);

        //Start moving
        this.bind('EnterFrame', this.update);
        console.info("Creep '%s' released", this.name);
    },

    update: function() {
        var point = Game.path[this.nextPoint];

        //Advance to the next point (TODO: precalculate and store)
        var dx = point[0] - this.x;
        var dy = point[1] - this.y;
        var angle = Math.atan2(dy, dx); // * 180 / Math.PI; // (r * 180 / pi)
        this.x += this.speed * Math.cos(angle);
        this.y += this.speed * Math.sin(angle);

        //this.rotation = angle;
        //console.log("a:", angle, "x,y:", this.x, this.y, "dx,dy:", dx, dy, point);

        if (this.intersect({x: point[0], y: point[1], h: Game.size / 6, w: Game.size / 6})) {
            this.nextPoint++;
            console.info("Creep '%s' arrived path point %s/%s", this.name, this.nextPoint, Game.path.length);

            // Creep reached end of the path
            if (this.nextPoint == Game.path.length) {
                console.info("Creep '%s' leaked", this.name);
                this.destroy();
            }
        }
    }
});




/*
 * Scenes
 */
// The loading screen
Crafty.scene("loading", function() {
    var text = Crafty.e("2D, Canvas, Text").attr({w: 0, h: 0, x: 0, y: 0})
                     .text("Loading...")
                     .textColor('#FFFFFF')

    //Debug path drawing
    for (i in Game.path) {
        var point = Game.path[i];
        Crafty.e("2D, Canvas, Color, tPoint")
              .attr({x: point[0], y: point[1], w: 5, h: 5})
              .color("#ffffff");
    }

    //Create creep
    /* Loader...not yet
    var loadObj = {
        "audio": {
            "miau": "snd/miau.mp3",
            "rasgar": "snd/rasgar.mp3",
            "music": "snd/elgato.mp3",
            "fail": "snd/fail.mp3",
            "win": "snd/win.mp3",
            "gameover": "snd/gameover.mp3"
        },
        "images": ["img/gato2.png", "img/sprite.png", "img/floor.png", "img/coda.png", "img/broom.png"]
        //"sprites": definition only valid for the callback of loader (why?)
    };

    /*Crafty.load(loadObj, function() {
        // On load
        // Create sprites
        Crafty.sprite(Game.tile, "img/floor.png", { piso: [0,0] });
        Crafty.sprite(Game.tile, "img/sprite.png", { cosas: [0,0] });
        Crafty.sprite(Game.tile, "img/gato2.png", { gato: [0,0] });
        Crafty.sprite(Game.tile, "img/coda.png", { coda: [0,0] });
        Crafty.sprite(Game.tile, "img/broom.png", { broom: [0,0] });

        // Ready, fire main menu
        Crafty.audio.play("miau", 1);
        Crafty.scene("menu");
    }, function(e) {
        // On progress
        console.log(e);
        text.text("Cargando " + Math.round(e.percent) + "%");
    }, function(e) {
        // On error
        console.debug(e);
    }); */
});


/**
 * Helpers
 */
function sendWave() {
    console.info("Sending wave %s", Game.wave_num);
    var time = 0; // accumaltive wave time

    for (i in Game.waves[Game.wave_num]) { // Iterate current wave
        var _sub = Game.waves[Game.wave_num][i];

        Crafty.e("Delay").delay(function() {
            var sub = Game.waves[Game.wave_num][Game.wave_sub]; //internal subwave
            console.info("Wave %s, sub %s", Game.wave_num, Game.wave_sub, sub);
            sendCreep(sub.name, sub.total, sub.delay);
            Game.wave_sub++;
        }, time, 0, function() {
            if (Game.wave_sub == Game.waves[Game.wave_num].length) {
                console.info("End of wave %s", Game.wave_num);
                Game.wave_sub = 0;
                Game.wave_num++;
            }
        });

        time += _sub.delay * _sub.total;
    }
}

function sendCreep(name, total, delay) {
    console.info("Sending %s creeps...", total, name);

    Crafty.e("Delay").delay(function() {
        Crafty.e("tCreep").creep(Game.creeps[name]);
    }, delay, total - 1, function() {
        console.info("Done sending %s", total, name);
    });
}

        </script>
    </body>
</html>