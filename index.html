<!-- JSTWR -->
<!DOCTYPE html>
<html>
    <head>
        <style></style>
        <title>jstwr</title>
        <script src="js/crafty.js"></script>
    </head>
    <body>
        <div id="game"></div>
        <button onclick="Crafty.scene('main')">Start</button>
        <button onclick="sendWave()">Next wave</button>

        <input type="text" disabled="true" size="100" id="hud" />
        <script>
/**
 * Game logic 
 */

/* Some parameters */
var Game = {};
Game.size = 32;
Game.version = 0.001;


/* Entry point */
window.onload = function() {
    Crafty.init(Game.size * 20, Game.size * 20, "game");
    Crafty.scene("loading");
};




/*
 * Components
 */
Crafty.c("tTower", {
    init: function() {
        //Setup
        this.addComponent("2D, Canvas, Color");
        this.origin("center");
        this.w = Game.size;
        this.h = Game.size;
        this.kills = 0;
        this.cooldown = 0;
    },

    tower: function(data, x, y) {
        /* this.name = obj.name;
        this.color(obj.color);
        this.range = obj.range;
        this.damage = obj.damage; */
        extend(this, data);
        this.color(data.__color); //DEBUG!!
        this.x = x;
        this.y = y;

        //Seek and destroy
        this.bind("EnterFrame", this.update);
    },

    update: function() {
        // Cooldown gun and fire bullets
        if (this.cooldown == 0) {
            this.cooldown = 40; // CHeck this from json data
            this.fireNearest();
            this.firing = true;
        } else {
            this.cooldown--;
        }
    },

    fireNearest: function() {
        var creeps = Crafty("tCreep").get();
        var min = 999999;
        var theCreep = false;

        for (i in creeps) {
            var creep = creeps[i];
            var dist = Crafty.math.squaredDistance(this.x, this.y, creep.x, creep.y);

            if (dist < min && Math.sqrt(dist) <= this.range) {
                min = dist;
                theCreep = creep;
            }
        }

        if (theCreep) {
            this.firing = true;
            Crafty.e("tBullet").bullet(this, theCreep);
        }

    }
});

Crafty.c("tBullet", {
    init: function() {
        //Setup
        this.addComponent("2D, Canvas, Color");
        this.origin("center");

        //This should be copied from the source tower??
        this.w = 2;
        this.h = 2;
        this.speed = 4;
        this.color("#444400");
    },

    bullet: function(source, target) {
        this.source = source;
        this.target = target;
        this.x = source.x;
        this.y = source.y;
        this.bind("EnterFrame", this.update);
    },

    update: function() {
        // This should be refactored in several functions, each one controlling 
        // one type of bullet. This is for "Seeking bullet"
        var angle = getAngle(this.target.x, this.target.y, this.x, this.y);
        this.x += this.speed * Math.cos(angle);
        this.y += this.speed * Math.sin(angle);

        if (this.intersect(this.target)) {
            this.target.hp -= this.source.damage;

            // Check if creep is destroyed
            if (this.target.hp <= 0) {
                creepDestroyed(this.source, this.target);
            }

            this.destroy();
        }
    }
});


Crafty.c("tCreep", {
    init: function() {
        //Setup
        this.addComponent("2D, Canvas, Color");
        this.origin("center");
        this.w = Game.size;
        this.h = Game.size;

        //Put in position
        this.x = Game.path[0][0];
        this.y = Game.path[0][1];
        this.nextPoint = 1;
    },

    creep: function(data) {
        extend(this, data);
        this.color(data.__color); // this is debug only

        //Start moving
        this.bind("EnterFrame", this.update);
        console.info("Creep '%s' released", this.name);
    },

    update: function() {
        var point = Game.path[this.nextPoint];

        //Advance to the next point (TODO: precalculate and store)
        var angle = getAngle(point[0], point[1], this.x, this.y);
        this.x += this.speed * Math.cos(angle);
        this.y += this.speed * Math.sin(angle);

        if (this.intersect({x: point[0], y: point[1], h: Game.size / 6, w: Game.size / 6})) {
            this.nextPoint++;
            console.info("Creep '%s' arrived path point %s/%s", this.name, this.nextPoint, Game.path.length);

            // Creep reached end of the path
            if (this.nextPoint == Game.path.length) {
                console.info("Creep '%s' leaked", this.name);
                creepLeaked(this);
            }
        }
    }
});




/*
 * Scenes
 */
// The loading screen
Crafty.scene("loading", function() {
    Crafty.background("#000000");

    var text = Crafty.e("2D, Canvas, Text").attr({w: 0, h: 0, x: 0, y: 0})
                     .text("Loading...")
                     .textColor('#FFFFFF');
});

Crafty.scene("main", function() {
    Crafty.background("#002200");

    //Load map
    loadMap();

    //Debug path & towerArea drawing
    debugDrawing();

    //Tower areas click entities
    for (i in Game.towerAreas) {
        Crafty.e("2D, Mouse, tTowerArea")
              .attr({x: 0, y: 0, w: Game.size * 20, h: Game.size * 20})
              .bind("Click", function(ev) { buyTower(ev) })
              .areaMap(new Crafty.polygon(Game.towerAreas[i]));
    }

    /* Loader...not yet
    var loadObj = {
        "audio": {
            "miau": "snd/miau.mp3",
            "rasgar": "snd/rasgar.mp3",
            "music": "snd/elgato.mp3",
            "fail": "snd/fail.mp3",
            "win": "snd/win.mp3",
            "gameover": "snd/gameover.mp3"
        },
        "images": ["img/gato2.png", "img/sprite.png", "img/floor.png", "img/coda.png", "img/broom.png"]
        //"sprites": definition only valid for the callback of loader (why?)
    };

    /*Crafty.load(loadObj, function() {
        // On load
        // Create sprites
        Crafty.sprite(Game.tile, "img/floor.png", { piso: [0,0] });
        Crafty.sprite(Game.tile, "img/sprite.png", { cosas: [0,0] });
        Crafty.sprite(Game.tile, "img/gato2.png", { gato: [0,0] });
        Crafty.sprite(Game.tile, "img/coda.png", { coda: [0,0] });
        Crafty.sprite(Game.tile, "img/broom.png", { broom: [0,0] });

        // Ready, fire main menu
        Crafty.audio.play("miau", 1);
        Crafty.scene("menu");
    }, function(e) {
        // On progress
        console.log(e);
        text.text("Cargando " + Math.round(e.percent) + "%");
    }, function(e) {
        // On error
        console.debug(e);
    }); */
});


/**
 * Helpers
 */
function sendWave() {
    console.info("Sending wave %s", Game.wave_num);
    var time = 0; // accumaltive wave time

    for (i in Game.waves[Game.wave_num]) { // Iterate current wave
        var _sub = Game.waves[Game.wave_num][i];

        Crafty.e("Delay").delay(function() {
            var sub = Game.waves[Game.wave_num][Game.wave_sub]; //internal subwave
            console.info("Wave %s, sub %s", Game.wave_num, Game.wave_sub, sub);
            sendCreep(sub.name, sub.total, sub.delay);
            Game.wave_sub++;
        }, time, 0, function() {
            if (Game.wave_sub == Game.waves[Game.wave_num].length) {
                console.info("End of wave %s", Game.wave_num);
                Game.wave_sub = 0;
                Game.wave_num++;
            }
        });

        time += _sub.delay * _sub.total;
    }

    updateHud();
}

function sendCreep(name, total, delay) {
    console.info("Sending %s creeps...", total, name);

    Crafty.e("Delay").delay(function() {
        Crafty.e("tCreep").creep(Game.creeps[name]);
    }, delay, total - 1, function() {
        console.info("Done sending %s", total, name);
    });
}

function buyTower(ev) {
    var towername = "one";
    var tower = Game.towers[towername];
    console.info("Buying tower %s-%s at", towername, tower.name, ev);

    if (Game.money >= tower.money) {
        Game.money -= tower.money;
        var entity = Crafty.e("tTower").tower(tower, ev.realX, ev.realY);
    } else {
        console.info("No money");
    }

    updateHud();
}

function loadMap() {
    /**
     * This is level data. Must be loaded from a JSON file/service/whatever
     */
    var data = {};
    data.money = 500;
    data.lives = 20;
    data.wave_num = 0;
    data.wave_sub = 0;
    data.path = [[50, 0], [200, 200], [350, 200], [0, 400]]; //Loaded from JSON
    data.towerAreas = [ [[50, 50], [150, 50], [100, 100]],
                        [[340, 50], [300, 150], [500, 150], [450, 50]] ];
    data.creeps = { //Loaded from JSON
        "oawc": {
            name: "Oaw",
            hp: 15,
            speed: 1,
            __color: "#ff0000",
            money: 1,
            lives: 1
        },
        "tldo": {
            name: "Taldo",
            hp: 40,
            speed: 2,
            __color: "#ffff00",
            money: 2,
            lives: 2
        },
        "stld": {
            name: "Super Taldo",
            hp: 80,
            speed: 3,
            __color: "#0000ff",
            money: 3,
            lives: 3
        },
    };
    data.towers = { //Loaded from JSON
        "one": {
            name: "Tower 1",
            damage: 5,
            __color: "#f0f0f0",
            money: 200,
            range: 200
        },
        "two": {
            name: "Tower 2",
            damage: 15,
            __color: "#0ff3fa",
            money: 400,
            range: 300
        }
    };
    data.waves = [ //Loaded from JSON
        [{name: "oawc", total: 4, delay: 2000},
         {name: "tldo", total: 1, delay: 800}],

        [{name: "oawc", total: 10, delay: 1000},
         {name: "tldo", total: 8, delay: 800},
         {name: "stld", total: 4, delay: 1200}]
    ];

    extend(Game, data);
    updateHud();
}

function creepLeaked(creep) {
    Game.lives -= creep.lives;
    updateHud();

    //Bye
    creep.destroy();
}

function creepDestroyed(source, creep) {
    source.kills++;
    Game.money += creep.money;
    updateHud();

    //Bye
    creep.destroy();
}

function updateHud() {
    var hud = "Money:" + Game.money + " Lives:" + Game.lives;
    document.getElementById("hud").value = hud
}

function getAngle(x1, y1, x2, y2) {
    var dx = x1 - x2;
    var dy = y1 - y2;

    return Math.atan2(dy, dx);
}

function debugDrawing() {
    for (i in Game.path) {
        var point = Game.path[i];
        Crafty.e("2D, Canvas, Color, tPoint")
              .attr({x: point[0], y: point[1], w: 5, h: 5})
              .color("#ffffff");
    }
    for (i in Game.towerAreas) {
        var points = Game.towerAreas[i];

        for (j in points) {
            var point = points[j];
            Crafty.e("2D, Canvas, Color, tPoint")
                  .attr({x: point[0], y: point[1], w: 5, h: 5})
                  .color("#ff00ff");
        }
    }
}

function extend(obj1, obj2) {
    var keys = Object.keys(obj2);

    for (i in keys) {
        var key = keys[i];
        obj1[key] = obj2[key];
    }
}

        </script>
    </body>
</html>